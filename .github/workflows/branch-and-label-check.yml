name: Branch & Label Policy
on:
  pull_request:
    types: [opened, edited, synchronize, labeled]

jobs:
  branch-name:
    name: Validate branch naming convention
    runs-on: ubuntu-latest
    steps:
      - name: Check branch
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Branch: $BRANCH"
          if [[ "$BRANCH" =~ ^(feature|bugfix|hotfix|refactor|docs|chore|ci|tests|perf|build)\/[-a-z0-9]+$ ]]; then
            echo "Branch name conforms to policy."; exit 0
          elif [[ "$BRANCH" =~ ^(release|dependabot)\/.*$ ]]; then
            echo "Branch is an allowed exception (release/dependabot)."; exit 0
          else
            echo "::error ::Branch name '$BRANCH' does not match required pattern (feature|bugfix|hotfix|refactor|docs|chore|ci|tests|perf|build)/kebab-case"; exit 1
          fi
  labels:
    name: Ensure at least one required PR label
    runs-on: ubuntu-latest
    steps:
      - name: Check labels
        uses: actions-ecosystem/action-release-label@v1
        if: always()
      - name: Validate labels manually
        uses: actions/github-script@v7
        with:
          script: |
            const required = ["feature","enhancement","bug","documentation","docs","maintenance","refactor","tests","ci","breaking-change"];
            const pr = context.payload.pull_request;
            const labels = pr.labels.map(l => l.name);
            core.info(`PR labels: ${labels.join(', ')}`);
            if (!labels.some(l => required.includes(l))) {
              core.setFailed("At least one category label (feature|bug|documentation|maintenance|tests|ci|breaking-change) is required.");
            }
